---
title: "ccplus"
author: "JL"
date: "6/2/2017"
output: html_document
---


```{r setup,include=FALSE}
library(ggplot2)
theme_set(theme_bw(20))
library(ConsensusClusterPlus)

options(digits=4)

stab = read.delim("/Users/Kitty/Downloads/P1-P2 HRS pilot2 data-2.csv",stringsAsFactors = FALSE,sep = ",") 
stab$CELLSID =gsub("TCELLS-CD8-NA.*","TCELLS-CD8-NAIVE",stab$CELLSID,fixed = FALSE)
stab$KEY = paste(stab$sample.ID,stab$time.point,stab$CELLSID)
stab$KEY2 = paste(stab$time.point,stab$CELLSID)
stab$sample.ID = as.character(stab$sample.ID)
stab$time.point =gsub("D","",stab$time.point)
stabPBMC = stab[which(stab$SAMPLE.TYPE=="PBMC"),]
stabWB = stab[which(stab$SAMPLE.TYPE=="WB"),]

stabGS = stab[which(stab$SAMPLE.TYPE=="WB"&stab$time.point==0),]

merge =merge(stabPBMC,stabWB,by.x = "KEY",by.y = "KEY")

metrics = data.frame()
sampleBased = data.frame(row.names = as.character(unique(merge$sample.ID.x)))


for (type in unique(merge$CELLSID.x)) {
  stabGST = stabGS[which(stabGS$CELLSID == type),]
  stabGST = stabGST[, c("sample.ID", "CELLS")]
  stabGST$NORM_CELLS = stabGST$CELLS
  # , color=SAMPLE.TYPE.x?
  data = merge[which(merge$CELLSID.x == type),]
  data = merge(data, stabGST, by.x = "sample.ID.x", by.y = "sample.ID")
  data$L2PBMC = log2(data$CELLS.x / data$NORM_CELLS)
  data$L2PBWB = log2(data$CELLS.y / data$NORM_CELLS)
  
  
  for (tp in unique(data$time.point.x)) {
    current = data[which(data$time.point.x == tp),]
    sampleTmp = data.frame(DATA1 = current$CELLS.x, DATA2 = current$CELLS.y)
    colnames(sampleTmp) = c(paste("PBMC", current$KEY2.x[1]),
                            paste("WB", current$KEY2.x[1]))
    row.names(sampleTmp) = current$sample.ID.x
    if (length(current$sample.ID.x) == length(as.character(unique(merge$sample.ID.x)))) {
      sampleBased = cbind(sampleBased, sampleTmp)
    }
    
    tmp = data.frame(
      TIME = as.numeric(tp),
      TYPE = type,
      L2PBMC_MED = median(current$L2PBMC, na.rm = TRUE),
      SD_L2PBMC = mad(current$L2PBMC, na.rm = TRUE),
      L2PBWB_MED = median(current$L2PBWB, na.rm = TRUE),
      SD_L2PBWB = mad(current$L2PBWB, na.rm = TRUE)
      
    )
    metrics  = rbind(metrics, tmp)
  }
}

k = 15
iter = 100
evalSource("ConcensusClusterPlus", package = "ConsensusClusterPlus", lock = TRUE, cache = FALSE)
insertSource("ConcensusClusterPlus.R", package = "ConsensusClusterPlus" )
# source("./ConcensusClusterPlus.R")
title = paste("test_sampleClust_transposeK", k, "iter", iter, sep = "")
resultst = ConsensusClusterPlus(
  t(as.matrix(sampleBased)),
  maxK = k,
  reps = iter,
  pItem = 0.8,
  pFeature = 1,
  title = title,
  clusterAlg = "hc",
  distance = "spearman",
  seed = 1262118388.71279,
  plot = "pdf",
  corUse = "pairwise.complete.obs"
)
title = paste("test_CellClustK", k, "iter", iter, sep = "")
resultsb = ConsensusClusterPlusJL(
  as.matrix(sampleBased),
  maxK = k,
  reps = iter,
  pItem = 0.8,
  pFeature = 1,
  title = title,
  clusterAlg = "hc",
  distance = "spearman",
  seed = 1262118388.71279,
  plot = "pdf",
  corUse = "pairwise.complete.obs"
)

write.table(sampleBased , file = "data.txt", sep = "\t")

```


>  The purpose of CM plots is to find the ‘cleanest’ cluster partition where items nearly always either cluster together giving a high consensus (dark blue colour) or do not cluster together giving a low consensus (white)

> Empirical cumulative distribution function (CDF) plots display consensus distributions for each k (Fig. 1C). The purpose of the CDF plot is to find the k at which the distribution reaches an approximate maximum, which indicates a maximum stability and after which divisions are equivalent to random picks rather than true cluster structure.


