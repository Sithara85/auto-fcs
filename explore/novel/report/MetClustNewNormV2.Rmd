---
title: "Clusters"
date: "6/15/2018"
output:
  ioslides_presentation:
    widescreen: true
    smaller: false
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(superheat)
library(scales)
library(plotly)
library(knitr)
library(ClusterR)

theme_set(theme_bw(15))


inDir = "/Volumes/Beta2/flow/detect_NewNorms_v2/"


# ,
types = c("subFirst_TRUE_normalize_FALSE.cents.scale","subFirst_FALSE_normalize_TRUE.cents.scale")

manuals = read.delim(
  "/Volumes/Beta/data/flow/kmeansValidateResults/results_r26_TcellSubs_Kmeans_wsp_v8/r26_v3_Manual_Samples.txt",
  stringsAsFactors = FALSE,
  header = FALSE
)

supeHe <- function(cents) {
  superheat(
    as.matrix(t(cents[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = T,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )
}

  centFiles <-
    list.files(
      inDir,
      pattern = paste0(types[1], "$"),
      full = TRUE,
      recursive = FALSE
    )
    markersToCluster = c("CD27",
                       "CD28",
                       "CD95",
                       "CCR7",
                       "CD45RA",
                       "CD8",
                       "CD4",
                       "CD3",
                       "CD19",
                       "IgD",
                       "HLA.DR")
  
  markersToCluster=rev(markersToCluster)
  
 cents =data.frame()
 for(file in centFiles){
   tmp=read.delim(file = file)
   # tmp[,markersToCluster]=center_scale(tmp[,markersToCluster])
   cents=rbind(cents,tmp)
 }
 
 # cents <- do.call(rbind, lapply(centFiles, read.delim))

cents$SAMPLE=as.character(cents$SAMPLE) 
 
 
  cents = cents[c(1:2000), ]
  

  
  cents$SANITIZE_NAME = gsub(" ", "_", cents$SAMPLE)
  
  
  cents$MANUAL_ANNOTATION = cents$SANITIZE_NAME %in% manuals$V1
  
  cents = cents[which(cents$MANUAL_ANNOTATION == FALSE), ]
  
  
  save(cents,file = "/Volumes/Beta2/flow/detect_NewNorms_v2/cents.RData")
  
  
  
  

```

## Input data

```{r, echo = FALSE}
myimages<-list.files("./", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

- running phenograph on Cytotoxic T cells from non-"manual" samples
- used following markers `r paste0(markersToCluster)`

## Phenograph Clusters detected



```{r }
clustTable=as.data.frame(table(as.character(cents$SAMPLE)))
g=ggplot(data=clustTable, aes(clustTable$Freq)) + geom_histogram(binwidth=1)+xlab("number of cytotoxic phenograph clusters")+ylab("number of samples")

ggplotly(g)

```

- n = `r length(unique(cents$SAMPLE))` samples, `r length(cents$SAMPLE)` total phenograph clusters
- median number of clusters per sample = `r median(clustTable$Freq)`

## Characterizing Phenograph Clusters

- For each Phenograph Cluster:
  - compute median expression (centroid) of each input marker
- group common centroids together

## Characterizing Phenograph Clusters

```{r fig.width=9}
superheat(
    as.matrix(t(cents[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )

```

- "x"-axis are individual phenograph clusters ordered by sample1,sample2,....
- "y"-axis is the median expression of each marker within that cluster



## Characterizing Phenograph Clusters

```{r fig.width=9}
min=-20
max=250

for (mark in markersToCluster) {
      cents[, mark] = squish(cents[, mark], range = c(min, max))
}
superheat(
    as.matrix(t(cents[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )

```

- expression "squished" to min of `r min` and max of `r max`
- outlier values are assigned either min or max 


<!-- ## Current notes -->

<!-- - Appears to be fairly cytotoxic with CD3+/CD8+, and _mostly_ CD4-/CD19- -->
<!--   - worried about Bcells -->


## Characterizing Phenograph Clusters


```{r fig.height=5,fig.width=9}
superheat(
    as.matrix(t(cents[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = T,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )



```

- "x"-axis ordered by common phenograph clusters 
- sorta grouped by "meta" clusters

```{r fig.height=5,fig.width=9}
 centFiles <-
    list.files(
      "/Volumes/Beta2/flow/detect_v1/",
      pattern = paste0("cents.inputData", "$"),
      full = TRUE,
      recursive = FALSE
    )
    markersToCluster = c("CD27",
                       "CD28",
                       "CD95",
                       "CCR7",
                       "CD45RA",
                       "CD8",
                       "CD4",
                       "CD3",
                       "CD19",
                       "IgD",
                       "HLA.DR")
  
  markersToCluster=rev(markersToCluster)

  library(openxlsx)
ctlCounts=read.xlsx("/Volumes/Beta/data/flow/controlValidate/combinedctlsOC2.xlsx", sheet =1)
rm =!(grepl("PBMC",ctlCounts$FCS.ID))
ctlCounts =ctlCounts[rm,]

# bn=basename(centFiles)
# bn=gsub(".cents.inputData","",bn)
# use=bn %in% ctlCounts$FCS.ID
 cents =data.frame()
 for(file in centFiles){
   if(gsub(".cents.inputData","",basename(file)) %in% ctlCounts$FCS.ID){
   tmp=read.delim(file = file,stringsAsFactors = FALSE)
   # tmp[,markersToCluster]=center_scale(tmp[,markersToCluster])
   cents=rbind(cents,tmp)
   }
 }

#  ctlDef=grepl("Ctl",centFiles,ignore.case = TRUE)  
# centFiles=centFiles[ctlDef]
# 
# ctlDef=!(grepl("Specimen",centFiles,ignore.case = TRUE))  
 
 # cents <- do.call(rbind, lapply(centFiles, read.delim))

cents$SAMPLE=as.character(cents$SAMPLE) 

# 
cents$CTL = gsub(".*Ctl-|.*CTL-|.*Ctl_|.*Clt-|.*Ctl|.*Ctl- |.*Ctl ","",cents$SAMPLE)
cents$CTL = gsub("_.*","",cents$CTL)
cents$CTL = gsub(" .*","",cents$CTL)
cents=cents[order(cents$CTL),]


```




## Characterizing Phenograph Clusters

```{r fig.height=5,fig.width=9}

ctlA=cents[which(cents$CTL=="A"),]
superheat(
    as.matrix(t(ctlA[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90,membership.cols = ctlA$SAMPLE
  )

```

- "x"-axis are individual phenograph clusters ordered by CtlASample1,CtlASample2,....


## Characterizing Phenograph Clusters

```{r fig.height=5,fig.width=9}

superheat(
    as.matrix(t(ctlA[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = T,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )

```



## Characterizing Phenograph Clusters

```{r fig.height=5,fig.width=9}

superheat(
    as.matrix(t(cents[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90,membership.cols = cents$CTL
  )

```

- "x"-axis are individual phenograph clusters ordered by CtlA,CtlB,....

