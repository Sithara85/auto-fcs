---
title: "Clustering Clusters"
date: "6/15/2018"
output:
  ioslides_presentation:
    widescreen: true
    smaller: false
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(superheat)
library(scales)
library(plotly)
library(knitr)
library(ClusterR)

theme_set(theme_bw(15))


inDir = "/Volumes/Beta2/flow/detect_NoNorm_v3//"

min=0
max=250



# ,
type = "subFirst_FALSE_normalize_TRUE.cents.scale"
type = "subFirst_TRUE_normalize_FALSE.cents.scale"


if(type=="subFirst_FALSE_normalize_TRUE.cents.scale") {
  min = -10
  max = 10
}
  

manuals = read.delim(
  "/Volumes/Beta/data/flow/kmeansValidateResults/results_r26_TcellSubs_Kmeans_wsp_v8/r26_v3_Manual_Samples.txt",
  stringsAsFactors = FALSE,
  header = FALSE
)

  
    markersToCluster = c("CD27",
                       "CD28",
                       "CD95",
                       "CCR7",
                       "CD45RA",
                       "CD8",
                       "CD4",
                       "CD3",
                       "CD19",
                       "IgD",
                       "HLA.DR")
  
  markersToCluster=rev(markersToCluster)

mapFull=read.delim("/Volumes/Beta/data/flow/results_r25_25full_SS_SubCD8_SCD14_Manuals/FULL/all.totalCellCounts.metrics.format.txt",
                         stringsAsFactors = FALSE,
                         header = TRUE)

map=mapFull  
# lsr =map[which(map$MACHINE=="LSR"),]   
map =map[which(map$PANEL=="panel1"),]
map =map[which(!is.na(map$LAB_ID)),]
# map =map[which(map$MACHINE=="LSR"),] 


```

```{r  include=FALSE,eval=FALSE}



centFiles <-
    list.files(
      inDir,
      pattern = paste0(type, "$"),
      full = TRUE,
      recursive = FALSE
    )
 cents =data.frame()
 for(file in centFiles){
   tmp=read.delim(file = file)
   # tmp[,markersToCluster]=center_scale(tmp[,markersToCluster])
   cents=rbind(cents,tmp)
 }
 
 # cents <- do.call(rbind, lapply(centFiles, read.delim))

cents$SAMPLE=as.character(cents$SAMPLE) 
 
 
  # cents = cents[c(1:2000), ]
  

  
  cents$SANITIZE_NAME = gsub(" ", "_", cents$SAMPLE)
  
  
  cents$MANUAL_ANNOTATION = cents$SANITIZE_NAME %in% manuals$V1
  
  cents = cents[which(cents$MANUAL_ANNOTATION == FALSE), ]
  
  studySample=cents$SAMPLE %in% map$FILE
  
  cents=cents[studySample,]
  
  
  # use=cents$SAMPLE %in% samplesUse
  # cents=cents[use,]

  library(openxlsx)
ctlCounts=read.xlsx("/Volumes/Beta/data/flow/controlValidate/combinedctlsOC2.xlsx", sheet =1)
rm =!(grepl("PBMC",ctlCounts$FCS.ID))
ctlCounts =ctlCounts[rm,]

# bn=basename(centFiles)
# bn=gsub(".cents.inputData","",bn)
# use=bn %in% ctlCounts$FCS.ID
 centsCtls =data.frame()
 for(file in centFiles){
   if(gsub(paste0("_",type),"",basename(file)) %in% ctlCounts$FCS.ID){
   tmp=read.delim(file = file,stringsAsFactors = FALSE)
   centsCtls=rbind(centsCtls,tmp)
   }
 }

centsCtls$SAMPLE=as.character(centsCtls$SAMPLE) 
  centsCtls$SANITIZE_NAME = gsub(" ", "_", centsCtls$SAMPLE)
  
  
  centsCtls$MANUAL_ANNOTATION = centsCtls$SANITIZE_NAME %in% manuals$V1
  
centsCtls = centsCtls[which(centsCtls$MANUAL_ANNOTATION == FALSE), ]
  
centsCtls$CTL = gsub(".*Ctl-|.*CTL-|.*Ctl_|.*Clt-|.*Ctl|.*Ctl- |.*Ctl ","",centsCtls$SAMPLE)
centsCtls$CTL = gsub("_.*","",centsCtls$CTL)
centsCtls$CTL = gsub(" .*","",centsCtls$CTL)
centsCtls=centsCtls[order(centsCtls$CTL),]

keep =!(cents$SAMPLE  %in% centsCtls$SAMPLE)
cents=cents[keep,]


cents=cents[keep,]

save(cents,file = "/Volumes/Beta2/flow/detect_NoNorm_v3/cents.RData")

# lsrCtls=centsCtls$SAMPLE %in% lsr$FILE
# centsCtls=centsCtls[lsrCtls,]
save(centsCtls,file = "/Volumes/Beta2/flow/detect_NoNorm_v3/centsCtls.RData")

  

```

## Input data

```{r, echo = FALSE,out.width="40%"}
load("/Volumes/Beta2/flow/detect_NoNorm_v3/cents.RData")
load("/Volumes/Beta2/flow/detect_NoNorm_v3/centsCtls.RData")

uniqSamps =unique(cents$SAMPLE)[1:500]
keep =(cents$SAMPLE  %in% uniqSamps)
cents=cents[keep,]

myimages<-list.files("./", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

- running phenograph on Cytotoxic T cells from non-"manual" study samples
- used following markers `r paste0(markersToCluster)`


## Phenograph Clusters detected



```{r }
currentData=centsCtls[which(centsCtls$CTL=="A"),]
clustTable=as.data.frame(table(as.character(currentData$SAMPLE)))
g=ggplot(data=clustTable, aes(clustTable$Freq)) + geom_histogram(binwidth=1)+xlab("number of cytotoxic phenograph clusters")+ylab("number of fcs files")

ggplotly(g)

```

- only within control sample "A"
- n = `r length(unique(currentData$SAMPLE))` fcs files


## Phenograph Clusters detected



```{r }
currentData=centsCtls[which(centsCtls$CTL=="A"),]
clustTable=as.data.frame(table(as.character(currentData$SAMPLE)))

clustTable$SAMPLE=as.character(clustTable$Var1)
merge =merge(clustTable,mapFull,by.x = "SAMPLE",by.y = "FILE")

g=ggplot(merge,
                aes(x = Freq,
                    y = TOTAL_COUNTS,color=MACHINE)) +
      geom_point() +xlab("number of cytotoxic phenograph clusters")+ylab("total events in FCS file")
ggplotly(g)

```

- only within control sample "A"
- spearman rho`r cor.test(merge$Freq,merge$TOTAL_COUNTS,method="spearman")$estimate`


## Characterizing Phenograph Clusters

- For each Phenograph Cluster:
  - compute median expression (centroid) of each input marker
- group common centroids together


## Characterizing Phenograph Clusters

```{r fig.width=9}
superheat(
    as.matrix(t(currentData[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )

```

- "x"-axis bars are individual phenograph clusters
- "y"-axis is the median expression of each marker within that cluster


## Characterizing Phenograph Clusters

```{r fig.width=9}
superheat(
    as.matrix(t(currentData[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90,membership.cols = currentData$SAMPLE,bottom.label = "none"
  )

```

- "x"-axis white lines separating individual CtlA .fcs files
- "y"-axis is the median expression of each marker within that cluster




## Characterizing Phenograph Clusters

```{r fig.width=9}

for (mark in markersToCluster) {
      currentData[, mark] = squish(currentData[, mark], range = c(min, max))
}
superheat(
    as.matrix(t(currentData[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90,membership.cols = currentData$SAMPLE,bottom.label = "none"
  )

```

- expression "squished" to min of `r min` and max of `r max`
- outlier values are assigned either min or max 


<!-- ## Current notes -->

<!-- - Appears to be fairly cytotoxic with CD3+/CD8+, and _mostly_ CD4-/CD19- -->
<!--   - worried about Bcells -->


## Characterizing Phenograph Clusters


```{r fig.height=5,fig.width=9}
superheat(
    as.matrix(t(currentData[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = T,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )



```

- "x"-axis ordered by common phenograph clusters 
- sorta grouped by "meta" clusters




## Phenograph Clusters detected



```{r }
currentData=centsCtls
for (mark in markersToCluster) {
      currentData[, mark] = squish(currentData[, mark], range = c(min, max))
}
clustTable=as.data.frame(table(as.character(currentData$SAMPLE)))
clustTable$SAMPLE=clustTable$Var1
map=unique(currentData[,c("SAMPLE","CTL")])
merge=merge(clustTable,map,by.x = "SAMPLE",by.y = "SAMPLE")
merge$SAMPLE=reorder(merge$SAMPLE, merge$Freq)
p1=ggplot(merge, aes(SAMPLE,Freq ,fill=CTL)) + geom_bar(stat = "identity")+theme(axis.text.x = element_text(angle = 90, hjust = 1)) +xlab("Sample")+ylab("Number of phenograph clusters")+theme(axis.text.x=element_blank())

ggplotly(p1)



# /Users/Kitty/git/auto-fcs/explore/novel/scripts/gatherSamps.sh


inputDir="/scratch.global/lanej/flow/novel/detect_NoNorm_v3_control_examples/"
msi="msi:"
msi=""

commands=c()
for (samp in unique(currentData$SAMPLE)) {
  command = paste0(
    "rsync -avz \'msi:/scratch.global/lanej/flow/full/fcs/",
    gsub(" ", "\\\ ", samp, fixed = TRUE),
    "' ",
    inputDir
  )
  commands=c(commands,command)
  
  
  msiKmeans="/scratch.global/lanej/flow/full/results_r26_TcellSubs_Kmeans_wsp_v8/FULL/*/kmeans/"
  command = paste0(
    "rsync -avz \'",msi,msiKmeans,
    gsub(" ", "\\\ ", samp, fixed = TRUE),
    "kmeans_panel1Rename.wsp' ",
    inputDir
  )
    commands=c(commands,command)
  
  msiKmeans="/scratch.global/lanej/flow/full/results_r26_TcellSubs_Kmeans_wsp_v8/FULL/*/kmeans/"
  command = paste0(
    "rsync -avz \'",msi,msiKmeans,
    gsub(" ", "\\\ ", samp, fixed = TRUE),
    ".boolMatrix.txt.gz' ",
    inputDir
  )
  commands=c(commands,command)

 
  
   phenoGraph="/scratch.global/lanej/flow/novel/detect_NoNorm_v3/"
  command = paste0(
    "rsync -avz \'",msi,phenoGraph,
    gsub(" ", "\\\ ", samp, fixed = TRUE),
    "_subFirst_TRUE_normalize_FALSE.boolMatrix.txt.gz' ",
    inputDir
  )

   commands=c(commands,command)

  # system(command)
}

write.table( commands,file ="./scripts/gatherSamps.sh",sep = "\t",quote = FALSE,row.names = FALSE,col.names = FALSE)


```


- all Ctl files
- n = `r length(unique(currentData$SAMPLE))` fcs files

## Phenograph Clusters detected



```{r }
currentData=centsCtls[which(centsCtls$CTL=="A"),]
clustTable=as.data.frame(table(as.character(currentData$SAMPLE)))

clustTable$SAMPLE=as.character(clustTable$Var1)
merge =merge(clustTable,mapFull,by.x = "SAMPLE",by.y = "FILE")

g=ggplot(merge,
                aes(x = Freq,
                    y = TOTAL_COUNTS,color=MACHINE)) +
      geom_point() +xlab("number of cytotoxic phenograph clusters")+ylab("total events in FCS file")
ggplotly(g)

```

- all Ctl files
- spearman rho`r cor.test(merge$Freq,merge$TOTAL_COUNTS,method="spearman")$estimate`



## Characterizing Phenograph Clusters

```{r fig.width=9}
superheat(
    as.matrix(t(currentData[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = F,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90,membership.cols = currentData$CTL
  )

```

- "x"-axis white lines separating individual Ctls (multiple .fcs)

## Characterizing Phenograph Clusters


```{r fig.height=5,fig.width=9}
superheat(
    as.matrix(t(currentData[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = T,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )



```

- "x"-axis ordered by common phenograph clusters 




## Phenograph Clusters detected



```{r }
currentData=cents
for (mark in markersToCluster) {
      currentData[, mark] = squish(currentData[, mark], range = c(min, max))
}
clustTable=as.data.frame(table(as.character(currentData$SAMPLE)))
g=ggplot(data=clustTable, aes(clustTable$Freq)) + geom_histogram(binwidth=1)+xlab("number of cytotoxic phenograph clusters")+ylab("number of samples")

ggplotly(g)

```

- n = `r length(unique(currentData$SAMPLE))` fcs files, `r length(currentData$SAMPLE)` clusters
- non-"manual" and non-Ctls


## Characterizing Phenograph Clusters


```{r fig.height=5,fig.width=9}
superheat(
    as.matrix(t(currentData[, markersToCluster])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = T,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )


```

- "x"-axis ordered by common phenograph clusters 




## Characterizing Phenograph Clusters


```{r fig.height=5,fig.width=9}
sub=markersToCluster[markersToCluster!="CD8"]
sub=sub[sub!="CD4"]
sub=sub[sub!="CD3"]
sub=sub[sub!="HLA.DR"]
sub=sub[sub!="CD19"]
sub=sub[sub!="IgD"]
superheat(
    as.matrix(t(currentData[, sub])),
    
    # place dendrograms on columns and rows
    row.dendrogram = F,
    col.dendrogram = T,
    
    # make gridlines white for enhanced prettiness
    grid.hline.col = "white",
    grid.vline.col = "white",
    
    # rotate bottom label text
    bottom.label.text.angle = 90
  )


```

- "x"-axis ordered by common phenograph clusters 



## Next Steps

1. Use something similar to marker enrichment modeling (MEM) to describe clusters
   - or at least scale median of cluster by SD/MAD
2. Output boolean matrices for visualization of populations in jFlow
2. Limit/adjust/iterate which markers are used as phenograph input



