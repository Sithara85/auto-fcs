---
title: "KmeansEval - full panel1"
author: "JL"
date: "2/14/2018"
output: 
  html_document: 
    keep_md: yes
---

Comparing global metrics (population median etc) between kmeans and manual

```{r include=FALSE,echo=FALSE}
library(openxlsx)
library(ggplot2)
library(reshape)


theme_set(theme_bw(10))
t2 <- theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(colour = "black"),
    axis.ticks = element_line(colour = "black"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.text.x=element_text(angle=90,hjust=1)
)
inDir ="/Volumes/Beta/data/flow/kmeansValidate/r26_TcellSubs"
outDir="/Volumes/Beta/data/flow/kmeansValidateResults/"
dir.create(outDir)
summaryFile=paste0(outDir,"summmary.counts.r26_TcellSubs.txt")
corSummaryFile=paste0(outDir,"summmary.cor.r26_TcellSubs.txt")

```


```{r setup, include=FALSE,eval=FALSE}

summFiles <-
  list.files(inDir,
             pattern = "counts.txt$",
             full = TRUE,
             recursive = FALSE)

summaries <- do.call(rbind,lapply(summFiles,read.delim))

map=read.delim("/Volumes/Beta/data/flow/results_r25_25full_SS_SubCD8_SCD14_Manuals/FULL/all.totalCellCounts.metrics.format.txt",
                         stringsAsFactors = FALSE,
                         header = TRUE)
map =map[which(map$PANEL=="panel1"),]
summaries =merge(summaries,map,by.x ="SAMPLE",by.y = "FILE" )

write.table( summaries,file =summaryFile,sep = "\t",quote = FALSE,row.names = FALSE)

```

```{r echo=FALSE,warning=FALSE,fig.height=8,fig.width=10}
summaries = read.delim(summaryFile,
                       stringsAsFactors = FALSE,
                       header = TRUE)
summaries$OPTIMAL_K = as.factor(summaries$OPTIMAL_K)
summaries = summaries[which(!is.na(summaries$LAB_ID)), ]
summaries$POPULATION = as.factor(summaries$POPULATION)
summaries$PARENT_FREQ = (summaries$COUNT * 100) / summaries$PARENT_COUNT
summaries = summaries[which(!is.na(summaries$PARENT_FREQ)), ]
summaries$KEY = paste0(summaries$LAB_ID, "_", summaries$POPULATION)

ggplot(summaries, aes(
  x = reorder(summaries$POPULATION, PARENT_FREQ, FUN = median),
  y = PARENT_FREQ,
  colour = POPULATION
)) +
  xlab(paste0("Population")) +
  ylab(paste0("Percent Parent")) + t2 +
  geom_boxplot() + ggtitle("Kmeans clustering") + ylim(0, 100)


origPercents = read.xlsx("/Volumes/Beta/data/flow/HRS1000 REPORT.xlsx", sheet =
                           1)
interest = c("Study.ID",
             "CM.CT" ,
             "E.CT" ,
             "EM.CT",
             "N.CT",
             "CM.HT" ,
             "E.HT",
             "EM.HT" ,
             "N.HT")


interestPercents = origPercents[, interest]
colnames(interestPercents) = c(
  "Study.ID",
  "CYTO_central memory" ,
  "CYTO_effector" ,
  "CYTO_effector memory",
  "CYTO_naive",
  "HELPER_central memory" ,
  "HELPER_effector",
  "HELPER_effector memory" ,
  "HELPER_naive"
)

interestPercentsM =  melt(interestPercents, id.vars = "Study.ID")
interestPercentsM$KEY = paste0(interestPercentsM$Study.ID, "_", interestPercentsM$variable)
ggplot(interestPercentsM, aes(
  x = reorder(interestPercentsM$variable, value, FUN = median),
  y = value,
  colour = variable
)) +
  xlab(paste0("Population")) +
  ylab(paste0("Percent Parent")) + t2 +
  geom_boxplot() + ggtitle("Manual gating") + ylim(0, 100)


combo = merge(summaries,
              interestPercentsM,
              by.x = "KEY",
              by.y = "KEY")

pops = unique(combo$POPULATION)


corSummary = data.frame()
for (pop in pops) {
  plotData = combo[which(combo$POPULATION == pop), ]
  cor1 = cor.test(
    as.numeric(plotData$PARENT_FREQ),
    as.numeric(plotData$value),
    method = "pearson",
    na.action = "na.omit"
  )
  cor2 = cor.test(
    as.numeric(plotData$PARENT_FREQ),
    as.numeric(plotData$value),
    method = "spearman",
    na.action = "na.omit"
  )
  
  g1 = ggplot(plotData,
              aes(x = PARENT_FREQ,
                  y = value, color = OPTIMAL_K)) +
    geom_point() +
    xlab(paste0("KMEANS percent parent")) +
    ylab(paste0("Manual percent parent")) + t2 + ggtitle(
      paste0(
        pop,
        "\npearson=",
        cor1$estimate,
        "\nspearman=",
        cor2$estimate,
        "\nN=",
        length(plotData$KEY)
      )
    )  +
    theme(legend.position = "bottom")
  
  print(g1)
  
  tmp = data.frame(
    POPULATION = pop,
    METRIC = "PARENT_FREQ",
    PEARSON = cor1$estimate,
    SPEARMAN = cor2$estimate
  )
  corSummary = rbind(corSummary, tmp)
}

write.table(
  corSummary,
  file = corSummaryFile,
  sep = "\t",
  quote = FALSE,
  row.names = FALSE
)



```

