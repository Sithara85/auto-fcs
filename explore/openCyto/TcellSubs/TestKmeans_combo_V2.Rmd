---
title: "Test K means"
author: "JL"
date: "1/26/2018"
output: 
  html_document: 
    keep_md: yes
---

```{r func, eval=TRUE ,echo=FALSE,warning=FALSE,fig.height=6,fig.width=8,message=FALSE}

require(flowCore)
require(tsne)
require(cytofkit)
library(ggcyto)
library(ClusterR)
library(gridExtra)

inputDir = "/Volumes/Beta/data/flow/testTcellSubFCS/"
outputDir = "/Volumes/Beta/data/flow/testTcellSubFCS/"

wsMapFileFile = "/Users/Kitty/git/auto-fcs/explore/openCyto/fcsLOCALMAP.manual.txt"
mapper = read.delim(wsMapFileFile,
                    stringsAsFactors = FALSE,
                    sep = "\t")
targets = 
  list.files(inputDir,
             pattern = ".fcs$",
             full = FALSE)
use = mapper$FCS %in% targets
mapper=mapper[use,]

alpha = 0.25

# samps = getSamples(ws)$name
# for (samp in samps) {
#   command = paste0(
#     "rsync -av \'msi:/scratch.global/lanej/flow/full/fcs/",
#     gsub(" ", "\\\ ", samp, fixed = TRUE),
#     "' ",
#     inputDir
#   )
#   system(command)
# }

biexpTrans <-
  flowJo_biexp_trans(
    channelRange = 256,
    maxValue = 262144.0000291775 ,
    pos = 4.418539922,
    neg = 0,
    widthBasis = -100
  )





nodesOfInterest = c("Helper Tcells-CD4+", "cytotoxic Tcells-CD8+")
tcellSubs = c(
  "naive helper Tcells (CCR7+ CD45RA+)",
  "effector memory helper Tcells (CCR7- CD45RA-)",
  "effector helper Tcells (CCR7- CD45RA+)",
  "central memory helper Tcells (CCR7+ CD45RA-)",
  "naive cytotoxic Tcells (CCR7+ , CD45RA+)",
  "effector memory cytotoxic Tcells (CCR7- , CD45RA-)",
  "effector cytotoxic Tcells  (CCR7-  CD45RA+)",
  "central memory cytotoxic Tcells (CCR7+ , CD45RA-)"
)
# "Comp-APC-Cy7-A", #CD4
# "Comp-BUV 395-A" #CD8

channels = c(#CCR7
  "Comp-BV 421-A",
  #CD28
  "Comp-BV 510-A",
  #CD45RA
  "Comp-BV 711-A",
  #CD95
  "Comp-BV 605-A")
clustChannels = channels[1:4]

#list samples in the workspace
#for every sample
for (samp in mapper$FCS[1:4]) {
  wsFile =mapper[which(mapper$FCS==samp),]$WSP
  print(wsFile)
  ws <- openWorkspace(wsFile)

  print(samp)
  #read the fcs file
  frame = read.FCS(paste(inputDir, samp, sep = ""))
  
  id =samp
  #load the workspace for this file, apply transforms, compensation, and gates
  gs <-
    parseWorkspace(
      ws,
      #WSP file
      path = inputDir,
      #FCS file
      name = 1,
      #sample group
      subset = id[1],
      #load single fcs file
      isNcdf = FALSE,
      #not memory mapped
      compensation = compensation(keyword(frame)$`SPILL`)
    )
  
  # for (node in nodesOfInterest) {
    print(samp)
    # print(table(getIndiceMat(gs, node)))
   combo =data.frame( ht=getIndiceMat(gs, nodesOfInterest[1])[,1],
    ct=getIndiceMat(gs, nodesOfInterest[2])[,1])
   combo$MDEF=combo$ct|combo$ht
   print(table(combo$MDEF))
   
    if (length(grep("TRUE",combo$MDEF )) < 500000) {
      gh <- gs[[1]]
      subdata = getData(gh)[combo$MDEF, ]
      t = as.data.frame(subdata@exprs)[, channels]
      clust = scale(t[, clustChannels])
      
      tsne <- cytof_dimReduction(
        data = clust,
        method = "tsne",
        out_dim = 2
      )
      
      results = as.data.frame(tsne)
      results$MANAUL_POP = "NA"
      for (pop in tcellSubs) {
        sub = getIndiceMat(gs, pop)[combo$MDEF]
        results[sub,]$MANAUL_POP = pop
      }
      results$CD45 = t$`Comp-BV 711-A`
      results$CCR7 = t$`Comp-BV 421-A`
      results$CD95 = t$`Comp-BV 605-A`
      results$CD28 = t$`Comp-BV 510-A`
      results$SET = "NA"
      results$SET[combo$ht[combo$MDEF]]="Helper Ts"
      results$SET[combo$ct[combo$MDEF]]="Cyto Ts"
      
      km_rc = KMeans_rcpp(
        clust,
        clusters = 4,
        num_init = 500,
        max_iters = 5000,
        
        initializer = 'optimal_init',
        threads = 3,
        verbose = T,
        seed = 42
      )
      
      results$CLUSTER_RAW = km_rc$clusters
      results$CLUSTER =as.factor(results$CLUSTER_RAW)
      # results$CLUSTER = gsub("4", "effector memory", results$CLUSTER)
      # results$CLUSTER = gsub("1", "central memory", results$CLUSTER)
      # results$CLUSTER = gsub("3", "naive", results$CLUSTER)
      # results$CLUSTER = gsub("2", "effector", results$CLUSTER)
      # 
      # results$CLUSTER = gsub("2","central memory", results$CLUSTER_RAW)
      # results$CLUSTER = gsub("1","effector memory", results$CLUSTER)
      # results$CLUSTER = gsub("4","naive", results$CLUSTER)
      # results$CLUSTER = gsub("3","effector", results$CLUSTER)
      # 
      library(ggplot2)
      
      t2 <- theme(
        axis.line = element_line(colour = "black"),
        axis.text = element_text(colour = "black"),
        axis.ticks = element_line(colour = "black"),
        # panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        # panel.grid.major.y = element_blank(),
        # panel.grid.minor.y = element_blank(),
        panel.border = element_blank(),
        # panel.background = element_blank(),
        # legend.position="none",
        axis.text.x = element_text(angle = 90, hjust = 1)
      )
      theme_set(theme_grey(base_size = 10))
      results$MANUAL_GATE = gsub("\\(.*", "", results$MANAUL_POP)
      results$MANUAL_GATE = gsub(" helper Tcells.*", "", results$MANUAL_GATE)
      results$MANUAL_GATE = gsub(" cytotoxic Tcells.*", "", results$MANUAL_GATE)
      
      
      p1c = ggplot(results,
                   aes(
                     x = CCR7,
                     y = CD45,
                     colour = MANUAL_GATE
                   )) +
        geom_point(alpha = alpha) +
        xlab(paste0("CCR7")) +
        ylab(paste0("CD45")) + t2 + ggtitle(paste0("MANUAL", "\n", samp)) +
        theme(legend.position = "bottom")+facet_wrap(~SET)
      
      p2c = ggplot(results,
                   aes(
                     x = CCR7,
                     y = CD45,
                     colour = CLUSTER
                   )) +
        geom_point(alpha = alpha) +
        xlab(paste0("CCR7")) +
        ylab(paste0("CD45")) + t2 + ggtitle(paste0("AUTO_CLUST", "\n", samp)) +
        theme(legend.position = "bottom")+facet_wrap(~SET)
      
      p1d = ggplot(results,
                   aes(
                     x = CD95,
                     y = CD28,
                     colour = MANUAL_GATE
                   )) +
        geom_point(alpha = alpha) +
        xlab(paste0("CD95")) +
        ylab(paste0("CD28")) + t2 + ggtitle(paste0("MANUAL", "\n", samp)) +
        theme(legend.position = "bottom")+facet_wrap(~SET)
      
      p2d = ggplot(results,
                   aes(
                     x = CD95,
                     y = CD28,
                     colour = CLUSTER
                   )) +
        geom_point(alpha = alpha) +
        xlab(paste0("CD95")) +
        ylab(paste0("CD28")) + t2 + ggtitle(paste0("AUTO_CLUST", "\n", samp)) +
        theme(legend.position = "bottom")+facet_wrap(~SET)
      
      pb1 = ggplot(results,
                   aes(
                     x = tsne_1,
                     y = tsne_2,
                     colour = MANUAL_GATE
                   )) +
        geom_point(alpha = alpha) +
        xlab(paste0("tsne1")) +
        ylab(paste0("tsne2")) + t2 + ggtitle(paste0("MANUAL", "\n", samp)) +
        theme(legend.position = "bottom")+facet_wrap(~SET)
      
      # + theme(legend.position = "none")
      # print(pb)
      
      pb2 = ggplot(results,
                   aes(
                     x = tsne_1,
                     y = tsne_2,
                     colour = CLUSTER
                   )) +
        geom_point(alpha = alpha) +
        xlab(paste0("tsne1")) +
        ylab(paste0("tsne2")) + t2 + ggtitle(paste0("AUTO_CLUST", "\n", samp)) +
        theme(legend.position = "bottom")+facet_wrap(~SET)
      # print(pb2)
      
      print(p1c+xlim(0,250))
      print(p2c+xlim(0,250))

      print(p1d+xlim(0,250))
      print(p2d+xlim(0,250))
      
      print(pb1)
      print(pb2)
      # grid.arrange(p1c, p2c,
      #              
      #              ncol = 1)
      # grid.arrange(p1d, p2d,
      #              ncol = 1)
      # grid.arrange(pb1,
      #              pb2,
      #              ncol = 1)
      
      
    }
  # }
}
# dev.off()

```
