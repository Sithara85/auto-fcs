---
title: "Replicate Concordance"
author: "JL"
date: "7/12/2017"
output: 
  html_document: 
    keep_md: yes
---

TODO 

- manual
- automatic
  - with/without QC
  
1. CV of reps
2. ICC
3. min diff
4. max diff
  
```{r setup,eval=FALSE, include=FALSE}
mets =   read.delim("/Volumes/Beta/data/flow/concordance/all.metrics.txt",stringsAsFactors = FALSE,sep = "\t") 
save(mets,file ="/Volumes/Beta/data/flow/concordance/all.metrics.Rdata" )

```

```{r eval=TRUE, echo=FALSE,warning=FALSE,include=FALSE}
library(knitr)
library(raster)
library("ggplot2")

theme_set(theme_bw(20))

load("/Volumes/Beta/data/flow/concordance/all.metrics.Rdata")
```

```{r eval=TRUE, echo=FALSE}
map = read.delim("/Users/Kitty/git/auto-fcs/explore/openCyto/panel1Map.txt",stringsAsFactors = FALSE,sep = "\t") 

ctrlUse =grepl("_Ctl",mets$name)
metsControls =mets[ctrlUse,]
metsControls$CTRL_NAME = gsub(".*_Ctl","",metsControls$name)
metsControls$CTRL_NAME = gsub("_G","G",metsControls$CTRL_NAME)
metsControls$CTRL_NAME = gsub("_.*","",metsControls$CTRL_NAME)
# kable(as.data.frame(table(metsControls$CTRL_NAME)),format = "markdown")
metsControls$CTRL_NAME = gsub("-","",metsControls$CTRL_NAME)
metsControls$CTRL_NAME = gsub("DHS","",metsControls$CTRL_NAME)
metsControls$CTRL_NAME = gsub("newbiolegend","",metsControls$CTRL_NAME)

metsControlsAuto = metsControls[which(metsControls$GATE=="AUTOMATIC"&metsControls$QC=="FALSE"&(metsControls$Population %in% map$Auto|metsControls$Parent=="root")&metsControls$METRIC=="count"),]
metsControlsAuto = merge(metsControlsAuto,map,by.x = "Population",by.y = "Auto",all.x = TRUE)

metsControlsAuto$Merge=paste(metsControlsAuto$Population,metsControlsAuto$name,sep = "_")
row.names(metsControlsAuto) =metsControlsAuto$Merge

for(pop in unique(map$Auto)) {
  for (sample in unique(metsControlsAuto$name)) {
    row = paste(pop, sample, sep = "_")
    sub = metsControlsAuto[which(metsControlsAuto$Population == pop &
                              metsControlsAuto$name == sample),]
    realParentCount = metsControlsAuto[which(metsControlsAuto$Population == sub$RealAutoParent &
                                          metsControlsAuto$name == sample),]$Count
    if (sub$RealAutoParent != "root") {
      metsControlsAuto[row, "freqParent"] = sub$Count / realParentCount
    }else{
      realParentCount = metsControlsAuto[which(metsControlsAuto$Parent == sub$RealAutoParent &
                                          metsControlsAuto$name == sample),]$ParentCount
      metsControlsAuto[row, "freqParent"] = sub$Count / realParentCount

    }
  }
}



metsControlsAuto$GROUP = paste(metsControlsAuto$CTRL_NAME,metsControlsAuto$Population)
kable(as.data.frame(table(metsControls$CTRL_NAME)),format = "markdown")

```



Total number of Control fcs files (currently) = `r length(unique(metsControls$name))`

Total number of Control groups (currently) = `r length(unique(metsControls$CTRL_NAME))`

```{r eval=TRUE, echo=FALSE,fig.width=10,fig.height=10}
df = data.frame()

for(pop in unique(map$Auto)) {
  for (group in unique(metsControlsAuto$CTRL_NAME)) {
    sub = metsControlsAuto[which(metsControlsAuto$Population == pop &
                              metsControlsAuto$CTRL_NAME == group),]
    # print(paste(pop,group,))
    #     print(paste(pop,group,cv(sub$Count,na.rm = TRUE)))
    tmp = data.frame(
      POP = pop,
      GROUP = group,
      CV = cv(sub$freqParent,na.rm = TRUE)
      
    )
    df = rbind.data.frame(df, tmp)

  }
}


p <- ggplot(metsControlsAuto, aes(x = Population, y = freqParent,colour = CTRL_NAME))+ geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust =
  1)) + ylab("% of parent") + xlab("population") + ggtitle("All Ctl groups")
p

p <- ggplot(metsControlsAuto[which(metsControlsAuto$CTRL_NAME %in% c("A","B","C","D")),], aes(x = Population, y = freqParent,colour = CTRL_NAME))+ geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust =
  1)) + ylab("% of parent") + xlab("population") + ggtitle("Ctl groups A,B,C,D")
p
for (group in unique(metsControlsAuto$CTRL_NAME)) {
  sub = metsControlsAuto[which(
  metsControlsAuto$CTRL_NAME == group), ]
  p <- ggplot(sub, aes(x = Population, y = freqParent))+ geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust =
  1)) + ylab("% of parent") + xlab("population") + ggtitle(paste("Ctl",group,"n =",length(unique(sub$name))))
  print(p)
}

p <- ggplot(df, aes(x=POP, y=CV))
p + geom_boxplot() +theme(axis.text.x=element_text(angle=90,hjust=1)) +ylab("CV of Group")+xlab("population")

```