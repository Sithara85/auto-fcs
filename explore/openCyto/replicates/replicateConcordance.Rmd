---
title: "Replicate Concordance"
author: "JL"
date: "7/12/2017"
output: 
  html_document: 
    keep_md: yes
---

TODO 

- manual
- automatic
  - with/without QC
  
1. CV of reps
2. ICC
3. min diff
4. max diff
  
```{r setup,eval=FALSE, include=FALSE}
mets =   read.delim("/Volumes/Beta/data/flow/concordance/all.metrics.txt",stringsAsFactors = FALSE,sep = "\t") 
save(mets,file ="/Volumes/Beta/data/flow/concordance/all.metrics.Rdata" )

```

```{r eval=TRUE, echo=FALSE}
library(knitr)
load("/Volumes/Beta/data/flow/concordance/all.metrics.Rdata")
```

```{r eval=TRUE, echo=FALSE}

map = read.delim("/Users/Kitty/git/auto-fcs/explore/openCyto/panel1Map.txt",stringsAsFactors = FALSE,sep = "\t") 

ctrlUse =grepl("_Ctl",mets$name)
metsControls =mets[ctrlUse,]
metsControls$CTRL_NAME = gsub(".*_Ctl","",metsControls$name)
metsControls$CTRL_NAME = gsub("_.*","",metsControls$CTRL_NAME)
# kable(as.data.frame(table(metsControls$CTRL_NAME)),format = "markdown")
metsControls$CTRL_NAME = gsub("-","",metsControls$CTRL_NAME)
metsControls$CTRL_NAME = gsub("DHS","",metsControls$CTRL_NAME)
metsControls$CTRL_NAME = gsub("newbiolegend","",metsControls$CTRL_NAME)

metsControlsAuto = metsControls[which(metsControls$GATE=="AUTOMATIC"&metsControls$QC=="FALSE"&(metsControls$Population %in% map$Auto|metsControls$Parent=="root")&metsControls$METRIC=="count"),]
metsControlsAuto = merge(metsControlsAuto,map,by.x = "Population",by.y = "Auto",all.x = TRUE)

for(pop in unique(map$Auto)) {
  for (sample in unique(metsControlsAuto$name)) {
    row = paste(pop, sample, sep = "_")
    sub = metsControlsAuto[which(metsControlsAuto$Population == pop &
                              metsControlsAuto$name == sample),]
    realParentCount = metsControlsAuto[which(metsControlsAuto$Population == sub$RealAutoParent &
                                          metsControlsAuto$name == sample),]$Count
    if (sub$RealAutoParent != "root") {
      metsControlsAuto[row, "freqParent"] = sub$Count / realParentCount
    }else{
      realParentCount = metsControlsAuto[which(metsControlsAuto$Parent == sub$RealAutoParent &
                                          metsControlsAuto$name == sample),]$ParentCount
      metsControlsAuto[row, "freqParent"] = sub$Count / realParentCount

    }
  }
}
kable(as.data.frame(table(metsControls$CTRL_NAME)),format = "markdown")

```



Total number of Control fcs files (currently) = `r length(unique(metsControls$name))`

Total number of Control groups (currently) = `r length(unique(metsControls$CTRL_NAME))`

